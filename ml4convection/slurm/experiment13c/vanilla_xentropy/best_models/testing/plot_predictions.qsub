#!/bin/tcsh

#SBATCH --job-name="plot_predictions"
#SBATCH --partition="fge"
#SBATCH --account="rda-ghpcs"
#SBATCH --qos="batch"
#SBATCH --ntasks=1
#SBATCH --nodes=1
#SBATCH --cpus-per-task=1
#SBATCH --mem=8G
##SBATCH --nodes=1
##SBATCH --ntasks=1
##SBATCH --cpus-per-task=1
##SBATCH --ntasks-per-node=1
#SBATCH --time=01:00:00
#SBATCH --array=1-45
#SBATCH --exclude=h28n12
##SBATCH --exclude=h31n03,h28n12
##SBATCH --exclude=h29n01,h26n05,h28n06,h29n07,h30n03,h30n15
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=ryan.lagerquist@noaa.gov
#SBATCH --output=plot_predictions_%A_%a.out

module load cuda/10.1
source /scratch2/BMC/gsd-hpcs/Jebb.Q.Stewart/conda3.7/etc/profile.d/conda.csh
conda activate base

set CODE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4convection_standalone/ml4convection"
set TOP_MODEL_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4convection_models/experiment13c/vanilla_xentropy"

set BATCH_SIZES=(60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60)
set L2_WEIGHTS=(0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000 0.0000001000)
set LAG_TIME_STRINGS_DASHED=("0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200" "0-1200")
set DATE_STRINGS=("20180101" "20180109" "20180117" "20180125" "20180202" "20180210" "20180218" "20180226" "20180306" "20180314" "20180322" "20180330" "20180407" "20180415" "20180423" "20180501" "20180509" "20180517" "20180525" "20180602" "20180610" "20180618" "20180626" "20180704" "20180712" "20180720" "20180728" "20180805" "20180813" "20180821" "20180829" "20180906" "20180914" "20180922" "20180930" "20181008" "20181016" "20181024" "20181101" "20181109" "20181117" "20181125" "20181203" "20181211" "20181219")

set batch_size=${BATCH_SIZES[$SLURM_ARRAY_TASK_ID]}
set l2_weight=${L2_WEIGHTS[$SLURM_ARRAY_TASK_ID]}
set lag_time_string_dashed=${LAG_TIME_STRINGS_DASHED[$SLURM_ARRAY_TASK_ID]}
set date_string=${DATE_STRINGS[$SLURM_ARRAY_TASK_ID]}

set batch_size_string=`printf "%02d" $batch_size`
set l2_weight_string=`printf "%.10f" $l2_weight`

set model_dir_name="${TOP_MODEL_DIR_NAME}/batch-size=${batch_size_string}_l2-weight=${l2_weight_string}_lag-times-sec=${lag_time_string_dashed}"
set model_file_name="${model_dir_name}/model.h5"
set prediction_dir_name="${model_dir_name}/testing/full_grids"

python3 -u "${CODE_DIR_NAME}/plot_predictions.py" \
--input_prediction_dir_name="${prediction_dir_name}" \
--first_date_string="${date_string}" \
--last_date_string="${date_string}" \
--use_partial_grids=0 \
--smoothing_radius_px=2 \
--daily_times_seconds 0 7200 14400 21600 28800 36000 43200 50400 57600 64800 72000 79200 \
--plot_deterministic=0 \
--output_dir_name="${prediction_dir_name}/prediction_plots"
